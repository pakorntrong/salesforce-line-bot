const express = require('express');
const jsforce = require('jsforce');
const cors = require('cors'); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏µ‡πâ
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000; // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô PORT ‡πÉ‡∏´‡∏ç‡πà

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° CORS Middleware
app.use(cors());
app.use(express.json());

// Salesforce Connection
const conn = new jsforce.Connection({
  loginUrl: 'https://login.salesforce.com'
});

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Salesforce
async function connectToSalesforce() {
  try {
    console.log('üîó Attempting Salesforce connection...');
    
    if (!process.env.SF_USERNAME || !process.env.SF_PASSWORD) {
      console.log('‚ùå Missing credentials');
      return false;
    }

    await conn.login(
      process.env.SF_USERNAME,
      process.env.SF_PASSWORD + (process.env.SF_TOKEN || '')
    );
    
    console.log('‚úÖ Connected to Salesforce!');
    return true;
    
  } catch (error) {
    console.error('‚ùå Salesforce connection failed:', error.message);
    
    // ‚úÖ ‡πÑ‡∏°‡πà throw error, return false ‡πÅ‡∏ó‡∏ô
    return false;
  }
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Health Check Endpoint (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Render)
app.get('/health', (req, res) => {
  res.status(200).json({ 
    status: 'OK', 
    timestamp: new Date().toISOString(),
    service: 'Salesforce-LINE-Bot',
    environment: process.env.NODE_ENV || 'development'
  });
});

// 2. Routes ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
app.get('/', (req, res) => {
  res.send(`
    <h1>üöÄ Salesforce + LINE Integration Server</h1>
    <p>Available endpoints:</p>
    <ul>
      <li><a href="/health">/health</a> - Health check</li>
      <li><a href="/test">/test</a> - Test connection</li>
      <li><a href="/accounts">/accounts</a> - Get Salesforce accounts</li>
      <li>POST /webhook/line - LINE webhook endpoint</li>
    </ul>
    <p>Environment: ${process.env.NODE_ENV || 'development'}</p>
  `);
});

// 3. Test endpoint
app.get('/test', (req, res) => {
  res.json({
    status: 'Server is running!',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV || 'development',
    port: PORT
  });
});

// 4. Get Salesforce data
app.get('/accounts', async (req, res) => {
  try {
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° reconnect ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    if (!conn.accessToken) {
      console.log('üîÑ Attempting to reconnect to Salesforce...');
      const connected = await connectToSalesforce();
      if (!connected) {
        return res.status(500).json({ 
          error: 'Not connected to Salesforce',
          details: 'Please check environment variables and try /connection-status'
        });
      }
    }

    const accounts = await conn.sobject('Account')
      .find({}, 'Id, Name, Type, Industry, Phone, Website')
      .limit(10);
    
    res.json({
      success: true,
      count: accounts.length,
      connection: {
        connected: true,
        userId: conn.userInfo.id
      },
      accounts: accounts
    });
    
  } catch (error) {
    console.error('‚ùå Error fetching accounts:', error);
    
    // Reset connection ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error
    conn.accessToken = null;
    
    res.status(500).json({ 
      success: false,
      error: error.message,
      suggestion: 'Check Salesforce credentials and security token'
    });
  }
});
// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° endpoint ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö connection status
app.get('/connection-status', async (req, res) => {
  try {
    const isConnected = !!conn.accessToken;
    const connectionInfo = {
      salesforce: {
        connected: isConnected,
        userId: conn.userInfo?.id,
        organizationId: conn.userInfo?.organizationId
      },
      environment: {
        node_env: process.env.NODE_ENV,
        has_username: !!process.env.SF_USERNAME,
        has_password: !!process.env.SF_PASSWORD,
        has_token: !!process.env.SF_TOKEN
      },
      timestamp: new Date().toISOString()
    };
    
    res.json(connectionInfo);
    
  } catch (error) {
    res.status(500).json({
      error: error.message,
      environment: {
        has_username: !!process.env.SF_USERNAME,
        has_password: !!process.env.SF_PASSWORD
      }
    });
  }
});
// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° LINE Signature Validation
const crypto = require('crypto');

function validateLineSignature(body, signature) {
  const channelSecret = process.env.LINE_CHANNEL_SECRET;
  if (!channelSecret) {
    console.log('‚ö†Ô∏è  LINE_CHANNEL_SECRET not found');
    return false;
  }
  
  const hash = crypto
    .createHmac('sha256', channelSecret)
    .update(body)
    .digest('base64');
  
  return hash === signature;
}

// 5. LINE Webhook endpoint (‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏•‡πâ‡∏ß)
// ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç LINE webhook endpoint
app.post('/webhook/line', express.json({ verify: (req, res, buf) => {
  req.rawBody = buf.toString();
}}), async (req, res) => {
  
  console.log('üì® LINE Webhook Received');
  
  try {
    // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡πà‡∏á 200 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô process ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å
    res.status(200).json({ 
      status: 'OK',
      message: 'Webhook received successfully'
    });

    // ‚úÖ Process events ‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á response ‡πÅ‡∏•‡πâ‡∏ß
    const events = req.body.events;
    
    if (!events || !Array.isArray(events)) {
      console.log('‚ö†Ô∏è  No events in webhook');
      return;
    }

    console.log(`üîç Processing ${events.length} events`);

    // Process each event
    for (let event of events) {
      if (event.type === 'message' && event.message.type === 'text') {
        console.log(`üí¨ Message from ${event.source.userId}: ${event.message.text}`);
        
        try {
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á case ‡πÉ‡∏ô Salesforce
          await createCaseInSalesforce(event.source.userId, event.message.text);
          console.log('‚úÖ Case created successfully');
        } catch (sfError) {
          console.error('‚ùå Salesforce error:', sfError.message);
          // ‚ùå ‡πÑ‡∏°‡πà throw error ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á 200 ‡πÅ‡∏•‡πâ‡∏ß
        }
      }
    }

  } catch (error) {
    console.error('‚ùå Webhook processing error:', error);
    // ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡∏™‡πà‡∏á error ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡πà‡∏á 200 ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
  }
});
// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö webhook ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
app.get('/webhook-test', (req, res) => {
  res.json({
    status: 'Webhook endpoint is ready',
    url: '/webhook/line',
    method: 'POST',
    timestamp: new Date().toISOString()
  });
});

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö simulate webhook
app.post('/simulate-webhook', async (req, res) => {
  try {
    const testEvent = {
      events: [
        {
          type: 'message',
          message: {
            type: 'text',
            text: 'Test message from simulation'
          },
          source: {
            userId: 'Utestuser1234567890'
          },
          replyToken: 'testreplytoken1234567890'
        }
      ]
    };

    // Simulate webhook call
    console.log('üß™ Simulating webhook...');
    await createCaseInSalesforce('Utestuser1234567890', 'Test message from simulation');
    
    res.json({
      success: true,
      message: 'Webhook simulation completed',
      testData: testEvent
    });

  } catch (error) {
    console.error('Simulation error:', error);
    res.status(500).json({ error: error.message });
  }
});
// 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Case ‡πÉ‡∏ô Salesforce
// ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ handle error ‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
async function createCaseInSalesforce(lineUserId, message) {
  try {
    // 1. ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Salesforce ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    if (!conn.accessToken) {
      console.log('üîÑ Reconnecting to Salesforce...');
      await connectToSalesforce();
    }

    let contactId = null;
    
    // 2. ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ Contact (optional)
    try {
      const contacts = await conn.sobject('Contact')
        .find({ LINE_User_ID__c: lineUserId }, 'Id, Name')
        .limit(1);

      if (contacts.length > 0) {
        contactId = contacts[0].Id;
        console.log(`üë§ Found contact: ${contacts[0].Name}`);
      }
    } catch (contactError) {
      console.log('‚ÑπÔ∏è  No contact found or field does not exist');
    }

    // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Case
    const newCase = {
      Subject: `LINE Message: ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}`,
      Description: `LINE User ID: ${lineUserId}\nMessage: ${message}`,
      Origin: 'LINE',
      Status: 'New',
      Priority: 'Medium'
    };

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° ContactId ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    if (contactId) {
      newCase.ContactId = contactId;
    }

    const result = await conn.sobject('Case').create(newCase);
    console.log('‚úÖ Case created:', result.id);
    return result;

  } catch (error) {
    console.error('‚ùå Error in createCaseInSalesforce:', error.message);
    
    // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÑ‡∏°‡πà throw error ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
    // ‡πÉ‡∏´‡πâ return error object ‡πÅ‡∏ó‡∏ô
    return { 
      error: true, 
      message: error.message 
    };
  }
}
// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö LINE
async function replyToLINE(replyToken, message) {
  try {
    const response = await fetch('https://api.line.me/v2/bot/message/reply', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.LINE_CHANNEL_ACCESS_TOKEN}`
      },
      body: JSON.stringify({
        replyToken: replyToken,
        messages: [
          {
            type: 'text',
            text: message
          }
        ]
      })
    });

    if (!response.ok) {
      throw new Error(`LINE API error: ${response.status}`);
    }

    console.log('‚úÖ Replied to LINE user');
  } catch (error) {
    console.error('‚ùå Failed to reply to LINE:', error);
  }
}

// ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó webhook endpoint ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏öÁî®Êà∑
app.post('/webhook/line', express.json({ verify: (req, res, buf) => {
  req.rawBody = buf.toString();
}}), async (req, res) => {
  
  console.log('üì® LINE Webhook Received');
  
  try {
    // ‡∏™‡πà‡∏á 200 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    res.status(200).json({ 
      status: 'OK',
      message: 'Webhook received successfully'
    });

    const events = req.body.events;
    
    if (!events || !Array.isArray(events)) {
      console.log('‚ö†Ô∏è  No events in webhook');
      return;
    }

    console.log(`üîç Processing ${events.length} events`);

    // Process each event
    for (let event of events) {
      if (event.type === 'message' && event.message.type === 'text') {
        const userMessage = event.message.text;
        const userId = event.source.userId;
        const replyToken = event.replyToken;
        
        console.log(`üí¨ Message from ${userId}: ${userMessage}`);
        
        try {
          // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á case ‡πÉ‡∏ô Salesforce
          const caseResult = await createCaseInSalesforce(userId, userMessage);
          
          // 2. ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏öÁî®Êà∑
          let replyMessage = "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì! ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞";
          
          if (caseResult && caseResult.id) {
            replyMessage = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (Case: ${caseResult.id.slice(-8)})`;
          }
          
          await replyToLINE(replyToken, replyMessage);
          console.log('‚úÖ Case created and user replied');
          
        } catch (sfError) {
          console.error('‚ùå Salesforce error:', sfError.message);
          
          // ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö user ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
          try {
            await replyToLINE(replyToken, "‚ö†Ô∏è ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á");
          } catch (replyError) {
            console.error('‚ùå Failed to send error reply:', replyError);
          }
        }
      }
    }

  } catch (error) {
    console.error('‚ùå Webhook processing error:', error);
  }
});
// ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏° server ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Render.com
async function startServer() {
  // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Salesforce (optional)
  await connectToSalesforce();
  
  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô '0.0.0.0' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Render
  app.listen(PORT, '0.0.0.0', () => {
    console.log('\nüéØ =================================');
    console.log('üöÄ Salesforce + LINE Integration Server');
    console.log(`üìç Running on: http://0.0.0.0:${PORT}`);
    console.log(`üåê Public URL: [‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Render ‡∏´‡∏•‡∏±‡∏á deploy]`);
    console.log('‚è∞ Started at:', new Date().toISOString());
    console.log('üéØ =================================\n');
    
    console.log('üìã Available Routes:');
    console.log('   GET  /              - Home page');
    console.log('   GET  /health        - Health check (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!)');
    console.log('   GET  /test          - Test server status');
    console.log('   GET  /accounts      - Get Salesforce accounts');
    console.log('   POST /webhook/line  - LINE webhook endpoint');
    console.log('\nüîß Environment:', process.env.NODE_ENV || 'development');
  });
}

// Start the server
startServer();